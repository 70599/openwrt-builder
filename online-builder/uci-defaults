cat << "EOF" > /etc/uci-defaults/99-init-foo
#!/bin/sh

# è®¾ç½®ä¸»æœºå
uci set system.@system[0].hostname='FOO'
uci commit system
hostname FOO

# è®¾ç½® LAN IP åœ°å€
uci set network.lan.ipaddr='10.10.1.1'
uci set network.lan.netmask='255.255.255.0'
uci commit network

# è®¾ç½® SSH ç«¯å£ï¼ˆDropbearï¼‰
uci set dropbear.@dropbear[0].Port='22333'
uci commit dropbear

# é‡å¯å—å½±å“çš„æœåŠ¡ï¼ˆæ³¨æ„ï¼šé¦–æ¬¡å¯åŠ¨æ—¶æœ‰äº›æœåŠ¡è¿˜æœªå°±ç»ªï¼‰
/etc/init.d/network restart
/etc/init.d/dropbear restart

exit 0
EOF

cat << "EOF" > /etc/uci-defaults/99-expand-tf
#!/bin/sh

# è·å–å½“å‰æ ¹åˆ†åŒºæ‰€åœ¨è®¾å¤‡ï¼ˆä¾‹å¦‚ /dev/mmcblk0ï¼‰
ROOT_DEV=$(df / | tail -1 | awk '{print $1}' | sed 's/[0-9]*$//')

# éå†æ‰€æœ‰ mmcblk è®¾å¤‡
for base_dev in /dev/mmcblk[0-9]; do
    [ "$base_dev" = "$ROOT_DEV" ] && continue
    [ -b "$base_dev" ] || continue

    echo "ğŸ” æ£€æµ‹åˆ° TF å¡è®¾å¤‡ï¼š$base_dev"

    # æ„å»ºç¬¬ 3 åˆ†åŒºè·¯å¾„
    PART="${base_dev}p3"
    PART_LABEL=$(basename "$PART")
    MOUNT_POINT="/mnt/$PART_LABEL"

    # å¦‚æœåˆ†åŒºå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º
    if [ -b "$PART" ]; then
        echo "âš ï¸ $PART å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºåˆ†åŒº"
    else
        echo "ğŸ’¾ åˆ›å»ºæ–°åˆ†åŒº $PART..."
        parted -s "$base_dev" -- mkpart primary f2fs 100%
        sleep 3
    fi

    # æ ¼å¼åŒ–ä¸º F2FSï¼ˆå¦‚æœæœªæ ¼å¼åŒ–ï¼‰
    FSTYPE=$(blkid -o value -s TYPE "$PART" 2>/dev/null)
    if [ "$FSTYPE" != "f2fs" ]; then
        echo "ğŸ§¹ æ­£åœ¨æ ¼å¼åŒ– $PART ä¸º F2FS..."
        mkfs.f2fs "$PART"
    else
        echo "âœ… $PART å·²æ ¼å¼åŒ–ä¸º F2FS"
    fi

    # åˆ›å»ºæŒ‚è½½ç‚¹
    mkdir -p "$MOUNT_POINT"

    # æ·»åŠ  fstab é…ç½®
    uci add fstab mount
    uci set fstab.@mount[-1].target="$MOUNT_POINT"
    uci set fstab.@mount[-1].device="$PART"
    uci set fstab.@mount[-1].fstype='f2fs'
    uci set fstab.@mount[-1].enabled='1'
    uci commit fstab

    # å°è¯•ç«‹å³æŒ‚è½½
    echo "ğŸš€ æŒ‚è½½ $PART åˆ° $MOUNT_POINT..."
    mount "$MOUNT_POINT"

    echo "âœ… å®Œæˆï¼š$PART â†’ $MOUNT_POINT"
    exit 0
done

echo "âŒ æœªæ‰¾åˆ°éæ ¹ mmcblk è®¾å¤‡ï¼Œæœªæ‰§è¡ŒæŒ‚è½½"
exit 0
EOF
